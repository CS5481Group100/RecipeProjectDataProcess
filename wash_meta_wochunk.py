import json
from typing import List, Dict
import re


# ===================== 1. å…ƒæ•°ç»„ç‰¹å¾é…ç½®ï¼ˆç”¨äºæå–å¹¶ä¸°å¯Œkeywordsï¼‰ =====================
DISH_TYPES = [
    # å…«å¤§èœç³»
    "å·èœ", "ç²¤èœ", "æ¹˜èœ", "é²èœ", "è‹èœ", "æµ™èœ", "é—½èœ", "å¾½èœ",
    # åœ°æ–¹ç‰¹è‰²èœ
    "ä¸œåŒ—èœ", "è¥¿åŒ—èœ", "è¥¿å—èœ", "ååŒ—èœ", "åå—èœ", "åä¸œèœ", "åä¸­èœ",
    "åŒ—äº¬èœ", "ä¸Šæµ·èœ", "å¤©æ´¥èœ", "é‡åº†èœ", "å››å·èœ", "æ¹–å—èœ", "å¹¿ä¸œèœ",
    # å›½å¤–èœç³»
    "è¥¿é¤", "æ—¥æ–™", "éŸ©é¤", "ä¸œå—äºšèœ", "æ³°å›½èœ", "è¶Šå—èœ", "æ„å¤§åˆ©èœ", "æ³•å›½èœ",
    # åœºæ™¯/åŠŸèƒ½èœ
    "å¿«æ‰‹èœ", "å®¶å¸¸èœ", "å®´å¸­èœ", "å‡è„‚é¤", "å¥èº«é¤", "å„¿ç«¥é¤", "è€äººé¤", "ç´ é£Ÿé¤",
    "æ—©é¤", "åˆé¤", "æ™šé¤", "å¤œå®µ", "å°åƒ", "ç”œå“", "æ±¤ç¾¹", "ä¸»é£Ÿ", "å‡‰èœ", "çƒ­èœ"
]

COOK_METHODS = [
    # åŸºç¡€çƒ¹é¥ª
    "ç‚’", "ç…®", "çƒ¤", "è’¸", "ç‚–", "ç…", "ç‚¸", "ç„–", "æ‹Œ", "çƒ©", "ç…²", "ç†¬",
    # ç»†åˆ†æ‰‹æ³•
    "æ»‘ç‚’", "æ¸…ç‚’", "çˆ†ç‚’", "ç…¸ç‚’", "å¹²ç‚’", "çº¢çƒ§", "ç™½ç…®", "æ¸…è’¸", "ç²‰è’¸", "æ±½è’¸",
    "æ…¢ç‚–", "å¿«ç‚–", "ç…¨ç‚–", "é¦™ç…", "ç…çƒ¤", "æ²¹ç‚¸", "è½¯ç‚¸", "å¹²ç‚¸", "æ²¹ç„–", "é…±ç„–",
    "å‡‰æ‹Œ", "æ¸©æ‹Œ", "ç”Ÿæ‹Œ", "æ¸…çƒ©", "çº¢çƒ©", "ç ‚é”…ç…²", "ç“¦ç½ç…²", "å¤åˆ¶", "è…Œåˆ¶", "ç†åˆ¶",
    "çƒ¤åˆ¶", "ç‚­çƒ¤", "ç”µçƒ¤", "çƒ¤ç®±çƒ¤", "é“æ¿çƒ§", "æ°´ç…®", "ç„¯æ°´", "è¿‡æ²¹", "å‹¾èŠ¡"
]

CORE_INGREDIENTS = [
    # è‚‰ç±»ï¼ˆç»†åˆ†éƒ¨ä½+å…·ä½“å“ç±»ï¼‰
    "çŒªè‚‰", "äº”èŠ±è‚‰", "ç˜¦è‚‰", "æ’éª¨", "çŒªè¹„", "çŒªé‡Œè„Š", "çŒªè‚", "çŒªè…°", "ç‰›è‚‰", "ç‰›è…©",
    "ç‰›è…±å­", "ç‰›é‡Œè„Š", "ç¾Šè‚‰", "ç¾Šæ’", "ç¾Šè…¿", "é¸¡è‚‰", "é¸¡èƒ¸è‚‰", "é¸¡è…¿", "é¸¡ç¿…", "é¸¡çˆª",
    "é¸­è‚‰", "é¸­è…¿", "é¸­ç¿…", "é¹…è‚‰", "å…”è‚‰", "é©´è‚‰", "ç‹—è‚‰", "è…Šè‚‰", "é¦™è‚ ", "ç«è…¿",
    # æµ·é²œ/æ°´äº§ï¼ˆç»†åˆ†å“ç±»ï¼‰
    "é±¼", "é²¤é±¼", "è‰é±¼", "é²ˆé±¼", "ä¸‰æ–‡é±¼", "é³•é±¼", "å¸¦é±¼", "é»„èŠ±é±¼", "è™¾", "åŸºå›´è™¾",
    "å¯¹è™¾", "å°é¾™è™¾", "èƒèŸ¹", "å¤§é—¸èŸ¹", "æ¢­å­èŸ¹", "è´ç±»", "æ‰‡è´", "ç”Ÿèš", "è›¤èœŠ",
    "é±¿é±¼", "å¢¨é±¼", "ç« é±¼", "æµ·å‚", "é²é±¼", "æµ·èœ‡", "æµ·å¸¦", "ç´«èœ", "è™¾ä»", "é±¼ç‰‡",
    # è”¬èœï¼ˆå¶èœ/æ ¹èŒ/ç“œèŒ„/èŒè‡ï¼‰
    "ç™½èœ", "è èœ", "ç”Ÿèœ", "æ²¹éº¦èœ", "èŠ¹èœ", "é¦™èœ", "è‘±", "å§œ", "è’œ", "æ´‹è‘±",
    "ç•ªèŒ„", "èŒ„å­", "é»„ç“œ", "å†¬ç“œ", "å—ç“œ", "ä¸ç“œ", "è‹¦ç“œ", "é’æ¤’", "çº¢æ¤’", "å½©æ¤’",
    "åœŸè±†", "çº¢è–¯", "å±±è¯", "èŠ‹å¤´", "è²è—•", "èƒ¡èåœ", "ç™½èåœ", "é’èåœ", "èŠ¦ç¬‹", "è¥¿å…°èŠ±",
    "èœèŠ±", "èŠ¥è“", "èœå¿ƒ", "èŒ¼è’¿", "ç”Ÿèœ", "ç´«è‹", "è–„è·", "èŒè‡", "é¦™è‡", "é‡‘é’ˆè‡",
    "æé²è‡", "èŸ¹å‘³è‡", "å¹³è‡", "æœ¨è€³", "é“¶è€³", "ç«¹èª", "æµ·å¸¦", "ç´«èœ",
    # æ°´æœï¼ˆå¸¸è§+çƒ¹é¥ªç”¨ï¼‰
    "è‹¹æœ", "é¦™è•‰", "æ©™å­", "æ©˜å­", "æŸšå­", "è‘¡è„", "è‰è“", "è“è“", "èŠ’æœ", "æ¦´è²",
    "è¥¿ç“œ", "æ¡ƒå­", "æ¢¨", "çŒ•çŒ´æ¡ƒ", "è è", "è”æ", "é¾™çœ¼", "æ¨±æ¡ƒ", "æ¨æ¢…", "æŸ æª¬",
    "ç™¾é¦™æœ", "ç‰›æ²¹æœ", "æœ¨ç“œ", "å±±æ¥‚", "çº¢æ£", "æ¡‚åœ†", "æ¸æ",
    # è±†åˆ¶å“/è›‹å“
    "è±†è…", "å«©è±†è…", "è€è±†è…", "è±†è…å¹²", "è±†è…çš®", "è…ç«¹", "è±†å¹²", "è±†èŠ½", "è±†æµ†",
    "é¸¡è›‹", "é¸­è›‹", "é¹…è›‹", "é¹Œé¹‘è›‹", "çš®è›‹", "å’¸è›‹",
    # ç±³é¢/æ‚ç²®
    "å¤§ç±³", "å°ç±³", "ç³¯ç±³", "é»‘ç±³", "ç‡•éº¦", "ç‰ç±³", "é«˜ç²±", "èéº¦", "å°éº¦", "é¢ç²‰",
    "é¢æ¡", "æŒ‚é¢", "æ‹‰é¢", "æ–¹ä¾¿é¢", "é¥ºå­", "åŒ…å­", "é¦’å¤´", "èŠ±å·", "é¢åŒ…", "è›‹ç³•",
    # åšæœ/å¹²è´§
    "èŠ±ç”Ÿ", "æ ¸æ¡ƒ", "æä»", "è…°æœ", "å¼€å¿ƒæœ", "ç“œå­", "æ¾å­", "æ¦›å­", "çº¢æ£", "æ¡‚åœ†",
    "è‘¡è„å¹²", "æ¸æ", "ç™¾åˆ", "è²å­", "èŠ¡å®"
]

TASTES = [
    # åŸºç¡€å£å‘³
    "è¾£", "ç”œ", "å’¸", "é…¸", "é²œ", "è‹¦", "éº»", "æ·¡", "é¦™",
    # å¤åˆå£å‘³
    "éº»è¾£", "é¦™è¾£", "é…¸è¾£", "ç”œè¾£", "å’¸è¾£", "é²œè¾£", "ç”œé…¸", "å’¸é²œ", "é²œé¦™",
    "é…±é¦™", "è’œé¦™", "è‘±é¦™", "å§œé¦™", "é…’é¦™", "æ¤’é¦™", "äº”é¦™", "å’–å–±", "å­œç„¶",
    "é…¸ç”œè¾£", "å’¸é²œé¦™", "éº»è¾£é²œ", "è’œé¦™è¾£",
    # å£å‘³å¼ºåº¦
    "æ¸…æ·¡", "æµ“éƒ", "åšé‡", "çˆ½å£", "æ²¹è…»", "æ¸…çˆ½", "é†‡åš",
    # å£æ„Ÿæè¿°ï¼ˆè¾…åŠ©åŒ¹é…ï¼‰
    "é…¥è„†", "è½¯ç³¯", "ç»µè½¯", "ç­‹é“", "Qå¼¹", "çˆ½å£", "æ»‘å«©", "é²œå«©", "è½¯çƒ‚"
]

# ===================== 2. å…ƒæ•°ç»„æå–å‡½æ•°ï¼ˆä»…ä¸°å¯Œkeywordsï¼Œä¸ä¿®æ”¹textï¼‰ =====================
def extract_meta_array(text: str, name: str) -> List[str]:
    """ä»é£Ÿè°±åç§°å’Œæ–‡æœ¬ä¸­æå–å…ƒæ•°ç»„ï¼ˆèœå“ç§ç±»ã€çƒ¹é¥ªæ–¹å¼ç­‰ï¼‰ï¼Œç”¨äºè¡¥å……keywords"""
    meta = []
    all_text = f"{name.lower()} {text.lower()}"  # åˆå¹¶æ–‡æœ¬æé«˜åŒ¹é…ç²¾åº¦

    # 1. æå–èœå“ç§ç±»
    for dish_type in DISH_TYPES:
        if dish_type.lower() in all_text:
            meta.append(dish_type)
    # 2. æå–çƒ¹é¥ªæ–¹å¼
    for method in COOK_METHODS:
        if method.lower() in all_text:
            meta.append(method)
    # 3. æå–æ ¸å¿ƒé£Ÿæï¼ˆä¼˜å…ˆåŒ¹é…recipeIngredientå­—æ®µï¼‰
    ingredient_match = re.search(r"recipeingredient:\s*(.+?)\s*recipeinstructions", text, re.IGNORECASE | re.DOTALL)
    ingredients = ingredient_match.group(1).strip().lower() if ingredient_match else ""
    for ingredient in CORE_INGREDIENTS:
        if ingredient.lower() in ingredients or ingredient.lower() in all_text:
            meta.append(ingredient)
    # 4. æå–å£å‘³é£æ ¼
    for taste in TASTES:
        if taste.lower() in all_text:
            meta.append(taste)

    return list(dict.fromkeys(meta))  # å»é‡ï¼Œä¿ç•™é¦–æ¬¡å‡ºç°é¡ºåº

# ===================== 3. ä¸»å¤„ç†å‡½æ•°ï¼ˆå®Œå…¨ä¸åˆ†å—ï¼Œä¿ç•™åŸå§‹Textï¼‰ =====================
def process_recipe_no_chunk(input_path: str, output_path: str):
    """
    å¤„ç†é€»è¾‘ï¼š
    1. ä»…ä¿ç•™æ ¸å¿ƒå­—æ®µï¼šoriginal_idã€nameã€keywordsã€textï¼ˆtextå®Œå…¨æ²¿ç”¨åŸå§‹å†…å®¹ï¼‰
    2. ä»…ä¼˜åŒ–keywordsï¼ˆåŸå§‹keywords + æå–çš„å…ƒæ•°ç»„ï¼Œå»é‡åˆå¹¶ï¼‰
    3. æ— ä»»ä½•åˆ†å—æ“ä½œï¼Œä¸æ–°å¢åˆ†å—ç›¸å…³å­—æ®µ
    """
    # åŠ è½½åŸå§‹é£Ÿè°±æ–‡ä»¶
    print(f"æ­£åœ¨åŠ è½½åŸå§‹é£Ÿè°±æ–‡ä»¶ï¼š{input_path}")
    try:
        with open(input_path, "r", encoding="utf-8") as f:
            input_data = json.load(f)
        # æ ¡éªŒè¾“å…¥æ ¼å¼ï¼ˆå¿…é¡»æ˜¯JSONæ•°ç»„ï¼‰
        if not isinstance(input_data, list):
            print("âŒ é”™è¯¯ï¼šè¾“å…¥æ–‡ä»¶ä¸æ˜¯JSONæ•°ç»„æ ¼å¼ï¼ˆéœ€ä¸ºé£Ÿè°±åˆ—è¡¨ï¼‰")
            return
        total_recipes = len(input_data)
        if total_recipes == 0:
            print("âŒ é”™è¯¯ï¼šè¾“å…¥æ–‡ä»¶ä¸ºç©ºåˆ—è¡¨ï¼Œæ— é£Ÿè°±å¯å¤„ç†")
            return
    except FileNotFoundError:
        print(f"âŒ é”™è¯¯ï¼šè¾“å…¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥è·¯å¾„ï¼š{input_path}")
        return
    except json.JSONDecodeError:
        print(f"âŒ é”™è¯¯ï¼šè¾“å…¥æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ï¼ˆè¯·æ£€æŸ¥è¯­æ³•ï¼‰")
        return
    except Exception as e:
        print(f"âŒ åŠ è½½æ–‡ä»¶å¤±è´¥ï¼š{str(e)}")
        return

    # å¤„ç†æ¯ä¸ªé£Ÿè°±ï¼ˆä»…ä¼˜åŒ–keywordsï¼Œä¿ç•™åŸå§‹textï¼‰
    processed_data = []
    for idx, item in enumerate(input_data, 1):
        # æå–åŸå§‹æ ¸å¿ƒå­—æ®µï¼ˆå…¼å®¹å­—æ®µç¼ºå¤±åœºæ™¯ï¼‰
        original_id = item.get("id", f"æœªçŸ¥ID_{idx}")  # ç¼ºå¤±idæ—¶è‡ªåŠ¨è¡¥å…¨
        name = item.get("name", f"æœªå‘½åé£Ÿè°±_{idx}")    # ç¼ºå¤±nameæ—¶è‡ªåŠ¨è¡¥å…¨
        text = item.get("text", "").strip()             # åŸå§‹textå®Œå…¨ä¿ç•™ï¼Œä¸ä¿®æ”¹
        original_keywords = item.get("keywords", [])    # åŸå§‹keywords

        # åˆå¹¶keywordsï¼ˆåŸå§‹keywords + æå–çš„å…ƒæ•°ç»„ï¼Œå»é‡ï¼‰
        meta_array = extract_meta_array(text, name)
        # æ¸…ç†åŸå§‹keywordsï¼ˆè¿‡æ»¤ç©ºå€¼ã€éå­—ç¬¦ä¸²ç±»å‹ï¼‰
        cleaned_original_kw = [
            str(kw).strip() 
            for kw in original_keywords 
            if isinstance(kw, (str, int, float)) and str(kw).strip()
        ]
        # åˆå¹¶å¹¶å»é‡ï¼ˆä¿ç•™åŸå§‹keywordsé¡ºåºï¼ŒååŠ çš„å…ƒæ•°ç»„æ’åé¢ï¼‰
        merged_keywords = list(dict.fromkeys(cleaned_original_kw + meta_array))

        # æ„å»ºæœ€ç»ˆå¤„ç†ç»“æœï¼ˆä»…æ ¸å¿ƒå­—æ®µï¼Œæ— åˆ†å—ç›¸å…³å†…å®¹ï¼‰
        processed_item = {
            "original_id": original_id,  # åŸå§‹IDï¼ˆä¸è¾“å…¥ä¸€è‡´ï¼‰
            "name": name,                # é£Ÿè°±åç§°ï¼ˆä¸è¾“å…¥ä¸€è‡´ï¼‰
            "keywords": merged_keywords, # ä¼˜åŒ–åçš„keywordsï¼ˆåŸå§‹+å…ƒæ•°ç»„ï¼‰
            "text": text                 # åŸå§‹æ–‡æœ¬ï¼ˆå®Œå…¨ä¸ä¿®æ”¹ï¼Œä¿æŒåŸæ ·ï¼‰
        }
        processed_data.append(processed_item)

    # ä¿å­˜å¤„ç†åçš„æ–‡ä»¶
    try:
        with open(output_path, "w", encoding="utf-8") as f:
            json.dump(processed_data, f, ensure_ascii=False, indent=2)
        print(f"âœ… å¤„ç†å®Œæˆï¼è¾“å‡ºæ–‡ä»¶å·²ä¿å­˜ï¼š{output_path}")
    except Exception as e:
        print(f"âŒ ä¿å­˜æ–‡ä»¶å¤±è´¥ï¼š{str(e)}")
        return

    # æ‰“å°å¤„ç†ç»Ÿè®¡ï¼ˆä»…æ ¸å¿ƒä¿¡æ¯ï¼Œæ— åˆ†å—ç»Ÿè®¡ï¼‰
    print(f"\nğŸ“Š å¤„ç†ç»“æœç»Ÿè®¡")
    print("="*50)
    print(f"æ€»å¤„ç†é£Ÿè°±æ•°é‡ï¼š{total_recipes}")
    print(f"å­—æ®µä¿ç•™æƒ…å†µï¼šoriginal_idã€nameã€keywordsã€textï¼ˆæ— åˆ†å—å­—æ®µï¼‰")
    print(f"keywordsä¼˜åŒ–ï¼šåŸå§‹keywords + è‡ªåŠ¨æå–çš„å…ƒæ•°ç»„ï¼ˆå»é‡åˆå¹¶ï¼‰")
    print(f"textçŠ¶æ€ï¼šå®Œå…¨ä¿ç•™åŸå§‹å†…å®¹ï¼Œæœªåšä»»ä½•ä¿®æ”¹")
    print("="*50)

# ===================== 4. æ‰§è¡Œå…¥å£ï¼ˆä¿®æ”¹è·¯å¾„åç›´æ¥è¿è¡Œï¼‰ =====================
if __name__ == "__main__":
    # è¯·æ ¹æ®ä½ çš„å®é™…æ–‡ä»¶è·¯å¾„ä¿®æ”¹ï¼ˆWindowsè·¯å¾„ç”¨åŒåæ–œæ \\ï¼Œæˆ–å•æ–œæ /ï¼‰
    INPUT_PATH = "stage2_output_full.json"       # åŸå§‹é£Ÿè°±è¾“å…¥æ–‡ä»¶ï¼ˆJSONæ•°ç»„ï¼‰
    OUTPUT_PATH = "recipe_no_chunk.json"    # å¤„ç†åè¾“å‡ºæ–‡ä»¶ï¼ˆæ— åˆ†å—å­—æ®µï¼‰

    # æ‰§è¡Œå¤„ç†
    process_recipe_no_chunk(INPUT_PATH, OUTPUT_PATH)